#!/bin/bash -ex
# vim: set filetype=sh :

# This script backs up the application to an archive file

echo Backing up Drupal
sudo -u "${php_user}" /bin/bash << END_OF_SUDO

# Variables
backup_dir=\$(dirname ${backup})
backup_file=\$(basename ${backup})
latest=\$(echo \${backup_file} | sed 's,[0-9][0-9]*\.tar\.gz,latest.tar.gz,')

set -x

# Backup with drush
mkdir -p \${backup_dir}
cd ${php_home}/drupal
drush archive-dump --destination=${backup}

# Create a latest symlink
cd \${backup_dir}
ln -sf \${backup_file} \${latest}

END_OF_SUDO
