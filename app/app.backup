#!/bin/bash -ex
# vim: set filetype=sh :

# This script backs up the application to an archive file

echo Backing up Drupal
sudo -u "${php_user}" /bin/bash -x << END_OF_SUDO
cd ${php_home}

# Backup with drush
backup_dir=\$(dirname ${backup})
mkdir -p \${backup_dir}
drush archive-dump --destination=${backup}

# Create a latest symlink
backup_file=\$(basename ${backup})
latest=\$(echo \${backup_file} | sed 's,[0-9][0-9]*\.tar\.gz,latest.tar.gz,')
cd \${backup_dir}
ln -sf \${backup_file} \${latest}

END_OF_SUDO
